---
title: "kde"
author: "ixxiiris"
date: "2025-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. 安装并加载必要包

```{r}
library(sf)
library(terra)
library(spatstat)
```
# 东京
## 2. 读取 GeoJSON 点数据与边界
```{r}
cafes <- st_read("urban_data_final/tokyo_cafes.geojson")
boundary <- st_read("urban_data_final/tokyo_boundary.geojson")

# 统一投影：推荐投影为 EPSG:3857（米）
cafes <- st_transform(cafes, 3857)
boundary <- st_transform(boundary, 3857)
```
##创建 ppp 对象（spatstat 的点模式）
```{r}
# 获取边界范围
bbox <- st_bbox(boundary)
win <- owin(xrange = c(bbox$xmin, bbox$xmax),
            yrange = c(bbox$ymin, bbox$ymax))

# 点坐标
coords <- st_coordinates(cafes)
pp <- ppp(x = coords[,1], y = coords[,2], window = win)
```

## 核密度
```{r}
# KDE 分辨率 & 带宽（sigma）可调
kde_raster <- density.ppp(pp, sigma = 1000, eps = 100)

# 转为 terra::rast 对象
kde_rast <- rast(kde_raster)
crs(kde_rast) <- "EPSG:3857"
```

